#!/bin/sh
# Pre-commit hook - Enforce JOOservices Platform quality gates
# See docs/principles.md for requirements

echo "ğŸ” Running pre-commit quality checks..."
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track overall status
CHECKS_PASSED=true

# Get list of staged PHP files
STAGED_PHP_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.php$')

# 1. Check for declare(strict_types=1) in staged PHP files
echo "1ï¸âƒ£  Checking declare(strict_types=1) in PHP files..."
if [ -n "$STAGED_PHP_FILES" ]; then
    MISSING_STRICT=""
    for file in $STAGED_PHP_FILES; do
        if [ -f "$file" ]; then
            # Check if file contains declare(strict_types=1)
            if ! grep -q "declare(strict_types=1)" "$file"; then
                # Skip config files that return arrays (optional exception)
                if [[ ! "$file" =~ ^config/ ]] && [[ ! "$file" =~ ^database/migrations/0001 ]]; then
                    MISSING_STRICT="$MISSING_STRICT\n  - $file"
                fi
            fi
        fi
    done
    
    if [ -n "$MISSING_STRICT" ]; then
        echo "${RED}âŒ ERROR: Missing declare(strict_types=1) in:${NC}"
        echo -e "$MISSING_STRICT"
        echo ""
        echo "${YELLOW}Fix: Add declare(strict_types=1); after <?php in each file${NC}"
        CHECKS_PASSED=false
    else
        echo "${GREEN}âœ… All staged PHP files have strict types${NC}"
    fi
else
    echo "${GREEN}âœ… No PHP files to check${NC}"
fi
echo ""

# 2. Run Laravel Pint
echo "2ï¸âƒ£  Running Laravel Pint (code style)..."
if composer lint:pint --test > /dev/null 2>&1; then
    echo "${GREEN}âœ… Pint: Code style is correct${NC}"
else
    echo "${YELLOW}âš ï¸  Pint: Auto-fixing code style...${NC}"
    composer lint:pint > /dev/null 2>&1
    
    # Re-add fixed files
    if [ -n "$STAGED_PHP_FILES" ]; then
        for file in $STAGED_PHP_FILES; do
            git add "$file" 2>/dev/null
        done
    fi
    echo "${GREEN}âœ… Pint: Style issues fixed and re-staged${NC}"
fi
echo ""

# 3. Run PHP_CodeSniffer
echo "3ï¸âƒ£  Running PHP_CodeSniffer (PSR-12)..."
if composer lint:phpcs > /dev/null 2>&1; then
    echo "${GREEN}âœ… PHPCS: PSR-12 compliance verified${NC}"
else
    echo "${RED}âŒ ERROR: PHPCS found PSR-12 violations${NC}"
    echo "${YELLOW}Run: composer lint:phpcs (to see details)${NC}"
    CHECKS_PASSED=false
fi
echo ""

# 4. Run PHPMD
echo "4ï¸âƒ£  Running PHPMD (design quality)..."
if composer analyze:phpmd > /dev/null 2>&1; then
    echo "${GREEN}âœ… PHPMD: Design quality verified${NC}"
else
    echo "${RED}âŒ ERROR: PHPMD found design issues${NC}"
    echo "${YELLOW}Run: composer analyze:phpmd (to see details)${NC}"
    CHECKS_PASSED=false
fi
echo ""

# 5. Run PHPStan
echo "5ï¸âƒ£  Running PHPStan (static analysis)..."
if composer analyze:phpstan > /dev/null 2>&1; then
    echo "${GREEN}âœ… PHPStan: Static analysis passed${NC}"
else
    echo "${RED}âŒ ERROR: PHPStan found type errors${NC}"
    echo "${YELLOW}Run: composer analyze:phpstan (to see details)${NC}"
    CHECKS_PASSED=false
fi
echo ""

# 6. Run tests
echo "6ï¸âƒ£  Running tests..."
if composer test > /dev/null 2>&1; then
    echo "${GREEN}âœ… Tests: All tests passed${NC}"
else
    echo "${RED}âŒ ERROR: Tests failed${NC}"
    echo "${YELLOW}Run: composer test (to see details)${NC}"
    CHECKS_PASSED=false
fi
echo ""

# 7. TypeScript validation (if TS files changed)
STAGED_TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|vue)$')
if [ -n "$STAGED_TS_FILES" ]; then
    echo "7ï¸âƒ£  Running TypeScript validation..."
    if npm run typecheck > /dev/null 2>&1; then
        echo "${GREEN}âœ… TypeScript: Type checking passed${NC}"
    else
        echo "${RED}âŒ ERROR: TypeScript validation failed${NC}"
        echo "${YELLOW}Run: npm run typecheck (to see details)${NC}"
        CHECKS_PASSED=false
    fi
    echo ""
fi

# Final verdict
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if [ "$CHECKS_PASSED" = true ]; then
    echo "${GREEN}âœ… All quality gates passed - commit allowed${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    exit 0
else
    echo "${RED}âŒ Quality gates failed - commit blocked${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "Fix the errors above and try again."
    echo "To skip this hook (NOT recommended): git commit --no-verify"
    echo ""
    exit 1
fi
